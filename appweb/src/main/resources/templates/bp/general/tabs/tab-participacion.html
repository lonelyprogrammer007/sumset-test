<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<meta charset=utf-8 />
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link th:href="@{/css/modal/select2.css}" rel="stylesheet">
<script
	src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
</head>
<body>
	<div class="abs-center mt-2 " style="font-size: 16px">
		<span><b>Participación</b></span><br>
		<div class="hr-1"></div>
	</div>
	<div class="row mt-3">
		<div class="col-sm-12">
			<div class="texto-archivo-plano ">Participación Ciudadana</div>
		</div>
	</div>
	<div id="entidadParticipacion">
		<div class="form-check">
			<input class="form-check-input aportes-archivo" type="radio"
				name="exampleRadios1" id="exampleRadios1" value="1"> <label
				class="form-check-label texto-archivo-plano" for="exampleRadios1">
				Aportes ciudadanos para la formulación del PDD </label> <a
				th:href="@{/asociar-aportes-ciudadanos}" class="texto-archivo-plano"
				style="float: right;">Ver Aportes Ciudadanos</a>
		</div>
		<div class="form-check">


			<input class="form-check-input aportes-otros" type="radio"
				name="exampleRadios2" id="exampleRadios2" value="2"> <label
				class="form-check-label texto-archivo-plano" for="exampleRadios2">
				Otros aportes y procesos de participación ciudadana</label>


		</div>
		<div class="form-check">
			<input class="form-check-input aportes-no-aplica" type="radio"
				name="exampleRadios3" id="exampleRadios3" value="3"> <label
				class="form-check-label texto-archivo-plano" for="exampleRadios3">
				No aplica </label>

		</div>
		<div class="row mt-3">
			<div class="col-sm-12">
				<div class="texto-archivo-plano ">Otros Aportes Ciudadanos</div>
			</div>
		</div>
		<div align="left" class="mb-3">

			<button class="boton-agregar mt-3" type="button"
				id="agregarOtrosAportes">
				<i class="fa fa-plus-circle"></i> Agregar
			</button>

		</div>
		<div class="table-responsive">
			<table class="table-striped" id="dtablaAporte" style="width: 175%">
				<thead>
					<tr>
						<th class="color-head">Aporte Ciudadano<br></th>
						<th class="color-head">Acción<br></th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
	</div>
	<div id="participacionAL">
		<div class="row mt-3">
			<div class="col-sm-12">
				<div class="texto-archivo-plano ">Participación ciudadana</div>
			</div>
		</div>

		<div class="form-check">
			<input class="form-check-input" type="radio" name="exampleRadios"
				id="exampleRadios1" value="option1" checked> <label
				class="form-check-label texto-archivo-plano" for="exampleRadios1">
				Iniciativas Locales </label>
		</div>

		<div class="form-check">
			<input class="form-check-input" type="radio" name="exampleRadios"
				id="exampleRadios3" value="option3"> <label
				class="form-check-label texto-archivo-plano" for="exampleRadios3">
				No aplica </label>

		</div>

		<div class="row mt-3">
			<div class="col-sm-12">
				<div class="texto-archivo-plano ">Iniciativas Ciudadanas</div>
			</div>
		</div>
		<div class="table-responsive">
			<table class="table-striped" id="dtablaIniciativas" style="width: 250%">
				<thead>
					<tr>
						<th class="color-head">Origen<br></th>
						<th class="color-head">Problematica o Necesidad <br></th>
						<th class="color-head">Alternativa de Solución <br></th>
						<th class="color-head">N. radicado <br></th>
						<th class="color-head">Código<br></th>
						<th class="color-head">Acción<br></th>
					</tr>
					
				</thead>
				<tbody>
				<tr th:each="iniciativa : ${iniciativas}">
				<td th:text="${iniciativa.nombreOrigen}"></td>
				<td th:text="${iniciativa.problematica}"></td>
				<td th:text="${iniciativa.alternativaSolucion}"></td>
				<td th:text="${iniciativa.numeroRad}"></td>
				<td th:text="${iniciativa.codigoIn}"></td>
				<td><input  th:attr="onclick=|seleccionarIndividual('${iniciativa.idIniciativa}')|" th:value="${iniciativa.idIniciativa}" type="checkbox" th:id="${iniciativa.idIniciativa}"></td>
				
				</tr>
				</tbody>
			</table>
		</div>
		<form th:object="${BpProyInvIniciativaDTO}" id="formAgregarIniciativas">
		<input type="hidden" value="5" name="idProyInversion">
		<input type="hidden" name="idsIniciativasConcatenadas" id="idsIniciativasConcatenadas">
		<div align="right" class="mt-3">
			<a th:href="@{/consultar-proyecto-entidad/1}" id="cancelar">Cancelar</a><span>&nbsp;&nbsp;</span>
			<button class="botonAgregarIndicadorMeta" name="btnAgregarNivel1"
				type="submit" id="boton-modal" >
				<img src="css/img/icono-guardar.png" class="guardar"
					alt="Icono guardar">&nbsp;&nbsp;Guardar
			</button>
	
		</div>
			</form>
	</div>
	<div
		th:include="bp/inscripcion-proyectos/modales/modal-agregar-otros-aportes.html"></div>
</body>

<script th:inline="javascript">
var niveles = "";
var iniciativasCheck = new Set();
$(document).ready(function() {
	/*<![CDATA[*/
		
		var entidad =/*[[${listaEntidadProy}]]*/;
		var pddVigente =/*[[${pddVigente}]]*/;
		var nivel1=/*[[${atributosNivel1}]]*/;
		var iniciativas=/*[[${iniciativas}]]*/;
	
		var select = document.getElementById("pddNivelAtributo1");
		select.innerHTML = '<option value="">Seleccione una opcion</option>';
		for (var i = 0; i < nivel1.length; i++) {
			 let opcion = document.createElement('option')
     		
       		 opcion.value = nivel1[i].idAtributo;
       		 opcion.text = nivel1[i].denominacion;
       	     select.add(opcion);
		}
		if(parseInt(pddVigente.stringNiveles)<3){
			$('#pddNivelAtributo3').hide();
		}
		
		$('#agregarOtrosAportes').attr('disabled',true);
		if(entidad.stringClasificacion=="Alcaldía"){
			cargarDatosAlcaldia();
			
			$('#entidadParticipacion').hide();
		}else{
			cargarTabla();
			$('#participacionAL').hide();
		}
	/*]]>*/
	$('.js-example-basic-single').select2({
			minimumResultsForSearch : Infinity
		});
	
	$('.form-check-input').change(function() {
		
		var val = $(this).val();
		if(val==3){
			$('.aportes-otros').prop('checked',false);
			$('.aportes-archivo').prop('checked',false);
			
		}else{
			$('.aportes-no-aplica').prop('checked',false);
		}
		if($('.aportes-otros').is(':checked')){
			$('#agregarOtrosAportes').attr('disabled',false);
		}else{
			$('#agregarOtrosAportes').attr('disabled',true);
		}
	});
	
	$('#agregarOtrosAportes').click(function () {
		$('#agregarAportesModal').modal('show');
		$('#idAporte').val('');
	     $('#accion').val('');
	     $('#fuente').val('');
	     $("#sectorDurante").val('').trigger('change');
	     $('#pddNivelAtributo2').val('').trigger('change');
	     $('#pddNivelAtributo3').val('').trigger('change');
	     $('#agregarAportesModal').modal('show');
		
	});
	
	
	
	$('#pddNivelAtributo1').change(function () {
		var id = $(this).val();
		/*<![CDATA[*/
			var nivel2=/*[[${atributosNivel2}]]*/;
		
		/*]]>*/
		for (var i = 0; i < nivel2.length; i++) {
			var select = document.getElementById("pddNivelAtributo2");
			select.innerHTML = '<option value="">Seleccione una opcion</option>';
			if(id==nivel2[i].idAtributoPadre){
				let opcion = document.createElement('option')
	     		
	       		 opcion.value = nivel2[i].idAtributo;
	       		 opcion.text = nivel2[i].denominacion;
	       	     select.add(opcion);
			}
		}
	});
	$('#pddNivelAtributo2').change(function () {
		var id = $(this).val();
		/*<![CDATA[*/
		var nivel3=/*[[${atributosNivel3}]]*/;
	
	/*]]>*/
	for (var i = 0; i < nivel3.length; i++) {
		var select = document.getElementById("pddNivelAtributo3");
		select.innerHTML = '<option value="">Seleccione una opcion</option>';
		if(id==nivel3[i].idAtributoPadre){
			let opcion = document.createElement('option')
     		
       		 opcion.value = nivel3[i].idAtributo;
       		 opcion.text = nivel3[i].denominacion;
       	     select.add(opcion);
		}
	}
		
	});
	$(document).on('submit','#formAgregarAporte',function (e){
		 e.preventDefault();
		var id = $('#idProyAporteModal').val();
	var data = $(this).serialize();
	var mensajeRespuesta = "";
	$.ajax({
  		type: 'POST',
 		url: '/Segplan/'+'registrar-aporte',
 		data: data,
  		beforeSend: function () {
      		Swal.fire({
          	title: 'Cargando...',
          	position: 'top',
          	allowOutsideClick: () => !Swal.isLoading(),
          	onBeforeOpen: () => {
              Swal.showLoading();
          }
      });
  },

  success: function (data) {
      Swal.close();
      mensajeRespuesta=data.msgRespuesta;
     
     $("#dtablaAporte").DataTable().destroy();
     
 	
     
     cargarTabla();
  },
  error:
          function () {
              Swal.close();

          },
          
  complete: function () {
              Swal.close();
            
              Swal.fire({
			        title:"¡Información!",
				    text: mensajeRespuesta,
			        icon: "warning",
			        confirmButtonText: 'Aceptar',
			        allowOutsideClick: () => false
		       })

          }
   });
	});
	$(document).on('submit','#formAgregarIniciativas',function (e){
		 e.preventDefault();
		 var separador = '';
		 var idIniciativas = '';
	for (let valor  of iniciativasCheck) {
		idIniciativas = idIniciativas + separador + valor;
		separador = ';'
	}	
	$('#idsIniciativasConcatenadas').val(idIniciativas);
	var data = $(this).serialize();
	var mensajeRespuesta = "";
	$.ajax({
 		type: 'POST',
		url: '/Segplan/'+'agregar-iniciativas',
		data: data,
 		beforeSend: function () {
     		Swal.fire({
         	title: 'Cargando...',
         	position: 'top',
         	allowOutsideClick: () => !Swal.isLoading(),
         	onBeforeOpen: () => {
             Swal.showLoading();
         }
     });
 },

 success: function (data) {
     Swal.close();
     mensajeRespuesta=data.msgRespuesta;
    
   
    
	
    
    
 },
 error:
         function () {
             Swal.close();

         },
         
 complete: function () {
             Swal.close();
           
             Swal.fire({
			        title:"¡Información!",
				    text: mensajeRespuesta,
			        icon: "warning",
			        confirmButtonText: 'Aceptar',
			        allowOutsideClick: () => false
		       })

         }
  });
	});
	$('.filter').on('click', function(e) {
		console.log("entro");
		e.stopPropagation();
	});
	$('#dtablaAporte').on('click','#ButtonEditar',function() {
		var id = $(this).parent().find('#idAporte');
		var id2 =$(id).val(); 
		var id3 = $(this).parent().find('#idProyAporte');
		var id4 =$(id).val(); 
		var data = $(this).serialize();
		$.ajax({
	  		type: 'GET',
	 		url: '/Segplan/'+'obtenerAportePorId/'+id2,
	 		data: data,
	  		beforeSend: function () {
	      		Swal.fire({
	          	title: 'Cargando...',
	          	position: 'top',
	          	allowOutsideClick: () => !Swal.isLoading(),
	          	onBeforeOpen: () => {
	              Swal.showLoading();
	          }
	      });
	  },

	  success: function (data) {
	  
	      
	  
	     console.log($('#idAporte'));
	     $('#idProyAporteModal').val(id4);
	     $('#idAporteModal').val(data.idAporte);
	     $('#accion').val(data.accion);
	     $('#fuente').val(data.fuente);
	     $('#idProyInversion').val(data.idProyInversion);
	     $("#sectorDurante").val(data.idLsSector).trigger('change');
	     $('#pddNivelAtributo2').val(data.idNivelAtributoPddOpcion2).trigger('change');
	     $('#pddNivelAtributo3').val(data.idNivelAtributoPddOpcion3).trigger('change');
	     $('#agregarAportesModal').modal('show');
	  },
	  error:
	          function () {
	             

	          },
	          
	  complete: function () {
	              Swal.close();
	            
	             

	          }
	});
	});
	
	$('#dtablaAporte').on('click','#ButtonEliminar',function() {
		var id = $(this).parent().find('#idProyAporte');
		var id2 =$(id).val(); 
		Swal.fire({
			  title: '¡Advertencia!',
			  text: "¿Está seguro que desea eliminar este registro?",
			  icon: 'warning',
			  showCancelButton: true,
			  confirmButtonColor: '#3085d6',
			  cancelButtonColor: '#d33',
			  confirmButtonText: 'Aceptar',
			  cancelButtonText: 'Cancelar'
			}).then((result) => {
			  if (result.value) {
				 
				  eliminarAporte(id2);
				
			  }
		})
	});
	 $('#dtablaIniciativas').DataTable().on("draw", function(){
  	   for (let valor of iniciativasCheck) {
		$('#'+valor).prop('checked',true);
	}
  	})
	cargarChecks();
});
function eliminarAporte(id) {
	var data = $(this).serialize();
	var mensajeRespuesta = "";
	$.ajax({
  		type: 'GET',
 		url: '/Segplan/'+'eliminar-aporte/'+id,
 		data: data,
  		beforeSend: function () {
      		Swal.fire({
          	title: 'Cargando...',
          	position: 'top',
          	allowOutsideClick: () => !Swal.isLoading(),
          	onBeforeOpen: () => {
              Swal.showLoading();
          }
      });
  },

  success: function (data) {
      Swal.close();
      mensajeRespuesta=data.msgRespuesta;
     
     $("#dtablaAporte").DataTable().destroy();
     $('#'+id).remove();
    
     cargarTabla();
    
  },   
  
  error: function () {
              Swal.close();

          },
          
  complete: function () {
              Swal.close();
            
              Swal.fire({
			        title:"¡Información!",
				    text: mensajeRespuesta,
			        icon: "warning",
			        confirmButtonText: 'Aceptar',
			        allowOutsideClick: () => false
		       })

          }
   });
}
function cargarDatos() {
	var tableAsignarEntidad = $('#dtablaAporte').DataTable({
		 
        "language": {
            "info": '<div class="formato">_END_ de _TOTAL_ registros</div>',
            "infoEmpty": '<div class="formato">0 de 0.</div>',
            "infoFiltered": "(filtrados de un total de _MAX_ registros)",
            "zeroRecords": "No se han encontrado coincidencias.",
            "destroy":true,
	    	  "colReorder" : true,
	  		"processing" : true,
	  		"serverSide" : true,
	  		"lengthChange" : true,
	  		"searching" : true,
	  		"ordering" : true,
	  		"info" : true,
	  		"autoWidth" : true,
            "paginate": {
                "first": '<img src="css/img/icono-flecha-doble-izquierda.png" class="flecha-paginador">',
                "last":  '<img src="css/img/icono-flecha-doble-derecha.png" class="flecha-paginador">',
                "next": '<img src="css/img/icono-flecha-derecha.png" class="flecha-paginador">',
                "previous":'<img src="css/img/icono-flecha-izquierda.png" class="flecha-paginador">'
            },
            "lengthMenu": "_MENU_",
        },
        "lengthMenu": [5, 10, 20, 50, 100],
        "pageLength": 5,
        "pagingType": "full_numbers",
        "dom": "<'row'<'col-sm-5 col-md-7'>>" +
                "<'row'<'col-sm-8 col-md-7'tr>>" +
                "<'row'<'col-sm-8 col-md-7'><'col-sm-2 col-md-1'l><'col-sm-1 col-md-1'i><'col-sm-1 col-md-3'p>>",

    });
    $('div.dataTables_length select').addClass("formato-2");
    $('#dtablaAporte  thead th').each( function () {
        var title = $(this).text();
        if (title !== "Acción" && title!=="Logo") {
        $(this).html( '<div class="form-group" id="centrado2">' + '<label for="th" class="blanco">' + title + '</label>' + '<div class="centrado">' + '<input class="form-control filter" id="nombre1" type="text"  placeholder="&#xf0b0; Filtrar ' + title + '" />' + '</div>' + '</div>' );
        }
    } );
    tableAsignarEntidad.columns().every(function () {
        var that = this;

        $('input', this.header()).on('keyup change clear', function () {
            if (that.search() !== this.value) {
                that
                        .search(this.value)
                        .draw();
            }
        });
    });
}
function cargarTabla() {
	var data = $(this).serialize();
	$.ajax({
        type: 'GET',
        url: '/Segplan/'+'obtenerAportesPorIdProyInv/'+5,
        data: data,
        

        success: function (data) {
            
            
        	console.log(data);
          	var datos = data.lstObjectsDTO;
          	for (var i = 0; i < datos.length; i++) {
          		$('#'+datos[i].idProyAporte).remove();
				var contenido = '<tr id="'+datos[i].idProyAporte+'">';
				contenido +='<td>'+datos[i].stringAporte+'</td>';
				contenido +='<td><button href="" type="button" id="ButtonEditar" class="edit"><img src="css/img/icono-1-azul.png" class="editar"></button><button href="" type="button" id="ButtonEliminar" class="edit"><input type="hidden" id="idAporte" value="'+datos[i].idAporte+'"><input type="hidden" id="idProyAporte" value="'+datos[i].idProyAporte+'"><img src="css/img/icono-eliminar.png" class="eliminar"></button></td>';
				contenido +='</tr>';
				$('#dtablaAporte').append(contenido);
			}
        },
        error:
                function () {
                    
                },
                
        complete: function (data) {
                   
        	cargarDatos();
                   

                }
         });
}
function cargarDatosAlcaldia() {
	var tableAsignarIniciativa = $('#dtablaIniciativas').DataTable({
		 
        "language": {
            "info": '<div class="formato">_END_ de _TOTAL_ registros</div>',
            "infoEmpty": '<div class="formato">0 de 0.</div>',
            "infoFiltered": "(filtrados de un total de _MAX_ registros)",
            "zeroRecords": "No se han encontrado coincidencias.",
            "destroy":true,
	    	  "colReorder" : true,
	  		"processing" : true,
	  		"serverSide" : true,
	  		"lengthChange" : true,
	  		"searching" : true,
	  		"ordering" : true,
	  		"info" : true,
	  		"autoWidth" : true,
            "paginate": {
                "first": '<img src="css/img/icono-flecha-doble-izquierda.png" class="flecha-paginador">',
                "last":  '<img src="css/img/icono-flecha-doble-derecha.png" class="flecha-paginador">',
                "next": '<img src="css/img/icono-flecha-derecha.png" class="flecha-paginador">',
                "previous":'<img src="css/img/icono-flecha-izquierda.png" class="flecha-paginador">'
            },
            "lengthMenu": "_MENU_",
        },
        "lengthMenu": [5, 10, 20, 50, 100],
        "pageLength": 5,
        "pagingType": "full_numbers",
        "dom": "<'row'<'col-sm-5 col-md-7'>>" +
                "<'row'<'col-sm-8 col-md-7'tr>>" +
                "<'row'<'col-sm-8 col-md-7'><'col-sm-2 col-md-1'l><'col-sm-1 col-md-1'i><'col-sm-1 col-md-3'p>>",

    });
    $('div.dataTables_length select').addClass("formato-2");
    $('#dtablaIniciativas  thead th').each( function () {
        var title = $(this).text();
        if (title !== "Acción" ) {
        $(this).html( '<div class="form-group" id="centrado2">' + '<label for="th" class="blanco">' + title + '</label>' + '<div class="centrado">' + '<input class="form-control filter" id="nombre1" type="text"  placeholder="&#xf0b0; Filtrar ' + title + '" />' + '</div>' + '</div>' );
        }
    } );
    tableAsignarIniciativa.columns().every(function () {
        var that = this;

        $('input', this.header()).on('keyup change clear', function () {
            if (that.search() !== this.value) {
                that
                        .search(this.value)
                        .draw();
            }
        });
    });
}
function cargarChecks() {
	var data = $(this).serialize();
	$.ajax({
        type: 'GET',
        url: '/Segplan/'+'obtenerIniciativasAsociadas/'+5,
        data: data,
        

        success: function (data) {
            
            
        	console.log(data);
          	var datos = data.lstObjectsDTO;
          	for (var i = 0; i < datos.length; i++) {
          		
				$('#'+datos[i].idIniciativa).prop('checked',true);
				iniciativasCheck.add(datos[i].idIniciativa);
				
			}
        	
          	
        },
        error:
                function () {
                    
                },
                
        complete: function (data) {
                   
        	
                   

                }
         });
}
function seleccionarIndividual(idIniciativa) {
	var check = $('#'+idIniciativa);
	if($(check).is(':checked')){
		iniciativasCheck.add(idIniciativa);
		console.log(iniciativasCheck);
	}else{
		iniciativasCheck.delete(idIniciativa);
	}
}
</script>
</html>